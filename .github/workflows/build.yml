name: Build libgpod

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            python-version: '3.10'
            artifact-name: libgpod-linux-x86_64-py3.10
          - os: ubuntu-24.04
            python-version: '3.12'
            artifact-name: libgpod-linux-x86_64-py3.12
          - os: macos-15-intel
            python-version: '3.12'
            artifact-name: libgpod-macos-x86_64-py3.12
          - os: macos-15
            python-version: '3.12'
            artifact-name: libgpod-macos-arm64-py3.12

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python packages
        run: pip install mutagen

      - name: Install system dependencies (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libsqlite3-dev \
            libplist-dev \
            zlib1g-dev \
            libgdk-pixbuf-2.0-dev \
            libxml2-dev \
            swig \
            intltool \
            gtk-doc-tools \
            gnome-common \
            python3-dev \
            gettext \
            autoconf \
            automake \
            libtool \
            pkg-config
          # libplist 2.x ships libplist-2.0.pc but configure.ac expects libplist.pc
          PLIST_PC=$(pkg-config --variable=pcfiledir libplist-2.0 2>/dev/null || true)
          if [ -n "$PLIST_PC" ] && [ ! -f "$PLIST_PC/libplist.pc" ]; then
            sudo ln -s "$PLIST_PC/libplist-2.0.pc" "$PLIST_PC/libplist.pc"
          fi

      - name: Install system dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install \
            glib \
            sqlite \
            libplist \
            gdk-pixbuf \
            libxml2 \
            swig \
            intltool \
            gtk-doc \
            automake \
            autoconf \
            libtool \
            gettext \
            pkg-config \
            perl \
            expat
          # intltool requires XML::Parser perl module; expat headers needed to build it
          EXPAT_PREFIX="$(brew --prefix expat)"
          PERL_MM_USE_DEFAULT=1 CPATH="$EXPAT_PREFIX/include" LIBRARY_PATH="$EXPAT_PREFIX/lib" \
            $(brew --prefix perl)/bin/cpan XML::Parser
          # Ensure gettext, libtool, and perl are on PATH
          echo "$(brew --prefix gettext)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix libtool)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix perl)/bin" >> $GITHUB_PATH
          # libplist 2.x ships libplist-2.0.pc but configure.ac expects libplist.pc
          PLIST_PC="$(brew --prefix libplist)/lib/pkgconfig"
          if [ -d "$PLIST_PC" ] && [ ! -f "$PLIST_PC/libplist.pc" ]; then
            ln -s "$PLIST_PC/libplist-2.0.pc" "$PLIST_PC/libplist.pc"
          fi

      - name: Generate build system
        run: autoreconf -fi

      - name: Configure
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            # Help pkg-config find brew packages
            export PKG_CONFIG_PATH="$(brew --prefix libplist)/lib/pkgconfig:$(brew --prefix glib)/lib/pkgconfig:$(brew --prefix gdk-pixbuf)/lib/pkgconfig:$(brew --prefix libxml2)/lib/pkgconfig:$(brew --prefix sqlite)/lib/pkgconfig:$PKG_CONFIG_PATH"
          fi
          ./configure \
            --with-python \
            --prefix=/usr/local \
            --disable-more-warnings \
            --without-hal \
            --disable-udev \
            --without-libimobiledevice

      - name: Fix gmodule linkage
        if: startsWith(matrix.os, 'macos')
        run: |
          # itdb_hashAB.c uses g_module_open/g_module_symbol from gmodule-2.0
          # but configure.ac only links glib-2.0 + gobject-2.0. Linux resolves
          # these transitively, macOS does not. Append gmodule-2.0 to LIBGPOD_LIBS
          # in src/Makefile which is what actually gets linked.
          export PKG_CONFIG_PATH="$(brew --prefix glib)/lib/pkgconfig:$PKG_CONFIG_PATH"
          GMODULE_LIBS="$(pkg-config --libs gmodule-2.0)"
          sed -i '' "s|^LIBGPOD_LIBS = \\(.*\\)|LIBGPOD_LIBS = \\1 ${GMODULE_LIBS}|" src/Makefile

      - name: Build
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            make -j$(nproc)
          else
            make -j$(sysctl -n hw.ncpu)
          fi

      - name: Install to staging directory
        run: make install DESTDIR=$(pwd)/staging

      - name: Package artifacts
        run: |
          cp -r webpod staging/webpod
          cd staging
          tar czf ../${{ matrix.artifact-name }}.tar.gz .
          cd ..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-name }}.tar.gz

      - name: Verify Python bindings
        run: |
          # Add the staged library paths so the module can be loaded
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            export LD_LIBRARY_PATH=$(pwd)/staging/usr/local/lib:$LD_LIBRARY_PATH
          else
            export DYLD_LIBRARY_PATH=$(pwd)/staging/usr/local/lib:$DYLD_LIBRARY_PATH
          fi
          PYTHONPATH=$(find staging -type d -name gpod | head -1 | xargs dirname)
          export PYTHONPATH
          python -c "import gpod; print('gpod module loaded successfully')"

  build-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - msystem: MINGW64
            arch: x86_64
            artifact-name: libgpod-windows-x86_64-py3.12

    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: >-
            mingw-w64-${{ matrix.arch }}-gcc
            mingw-w64-${{ matrix.arch }}-glib2
            mingw-w64-${{ matrix.arch }}-sqlite3
            mingw-w64-${{ matrix.arch }}-libplist
            mingw-w64-${{ matrix.arch }}-zlib
            mingw-w64-${{ matrix.arch }}-gdk-pixbuf2
            mingw-w64-${{ matrix.arch }}-libxml2
            mingw-w64-${{ matrix.arch }}-swig
            mingw-w64-${{ matrix.arch }}-python
            mingw-w64-${{ matrix.arch }}-python-mutagen
            mingw-w64-${{ matrix.arch }}-pkg-config
            autoconf
            automake
            libtool
            intltool
            gettext-devel
            make

      - name: Create libplist pkg-config compatibility symlink
        run: |
          PLIST_PC=$(pkg-config --variable=pcfiledir libplist-2.0 2>/dev/null || true)
          if [ -n "$PLIST_PC" ] && [ ! -f "$PLIST_PC/libplist.pc" ]; then
            ln -s "$PLIST_PC/libplist-2.0.pc" "$PLIST_PC/libplist.pc"
          fi

      - name: Generate build system
        run: |
          # gtk-doc is not available in MSYS2. We need three stubs:
          # 1. gtkdocize — autoreconf invokes this when it sees GTK_DOC_CHECK
          # 2. gtk-doc.m4 — defines GTK_DOC_CHECK so aclocal can expand it
          # 3. gtk-doc.make — included by docs/reference/Makefile.am at automake time
          mkdir -p /usr/local/bin
          cat > /usr/local/bin/gtkdocize << 'SCRIPT'
          #!/bin/sh
          exit 0
          SCRIPT
          chmod +x /usr/local/bin/gtkdocize
          cat > m4/gtk-doc.m4 << 'M4EOF'
          dnl Stub GTK_DOC_CHECK for environments without gtk-doc
          AC_DEFUN([GTK_DOC_CHECK], [
            AM_CONDITIONAL([ENABLE_GTK_DOC], [false])
            AM_CONDITIONAL([GTK_DOC_BUILD_HTML], [false])
            AM_CONDITIONAL([GTK_DOC_BUILD_PDF], [false])
            AM_CONDITIONAL([GTK_DOC_USE_LIBTOOL], [false])
            AM_CONDITIONAL([GTK_DOC_USE_REBASE], [false])
          ])
          M4EOF
          printf 'EXTRA_DIST =\nCLEANFILES =\n' > gtk-doc.make
          autoreconf -fi

      - name: Configure
        run: |
          ./configure \
            --with-python \
            --prefix=/mingw64 \
            --disable-more-warnings \
            --disable-gtk-doc \
            --without-hal \
            --disable-udev \
            --without-libimobiledevice

      - name: Fix gmodule linkage
        run: |
          # itdb_hashAB.c uses g_module_open/g_module_symbol from gmodule-2.0
          # but configure.ac only links glib-2.0 + gobject-2.0. Windows does not
          # resolve these transitively. Append gmodule-2.0 to LIBGPOD_LIBS.
          GMODULE_LIBS="$(pkg-config --libs gmodule-2.0)"
          sed -i "s|^LIBGPOD_LIBS = \\(.*\\)|LIBGPOD_LIBS = \\1 ${GMODULE_LIBS}|" src/Makefile

      - name: Build
        run: make -j$(nproc)

      - name: Install to staging directory
        run: make install DESTDIR=$(pwd)/staging

      - name: Package artifacts
        run: |
          cp -r webpod staging/webpod
          cd staging
          tar czf ../${{ matrix.artifact-name }}.tar.gz .
          cd ..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-name }}.tar.gz

      - name: Verify Python bindings
        run: |
          export PATH="$(pwd)/staging/mingw64/bin:$PATH"
          PYTHONPATH=$(find staging -type d -name gpod | head -1 | xargs dirname)
          export PYTHONPATH
          python -c "import gpod; print('gpod module loaded successfully')"

  release:
    needs: [build, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Check if release exists and has empty notes - if so, delete it
          if gh release view "$TAG" &>/dev/null; then
            NOTES=$(gh release view "$TAG" --json body -q '.body')
            if [ -z "$NOTES" ]; then
              echo "Existing release has empty notes, replacing it..."
              gh release delete "$TAG" --yes
            else
              echo "Existing release has notes, not replacing. Failing."
              exit 1
            fi
          fi
          # Collect all tarballs
          FILES=$(find artifacts -name '*.tar.gz' -type f)
          gh release create "$TAG" \
            --title "WebPod $TAG" \
            --notes "See the [README](../../blob/master/README.md) for installation instructions.

          **Downloads:**
          - Windows: \`libgpod-windows-x86_64-py3.12.tar.gz\`
          - macOS Apple Silicon: \`libgpod-macos-arm64-py3.12.tar.gz\`
          - macOS Intel: \`libgpod-macos-x86_64-py3.12.tar.gz\`
          - Linux (Ubuntu 24.04): \`libgpod-linux-x86_64-py3.12.tar.gz\`
          - Linux (Ubuntu 22.04): \`libgpod-linux-x86_64-py3.10.tar.gz\`" \
            $FILES
